function addscript(source) {
    $("<script>", {
        type: "text/javascript",
        text: source
    }).appendTo("head");
}

GM_addStyle("#zzBackup fieldset{counter-reset:section;border:1px solid #07f}#zzBackup legend{color:#e000a2}#zzBackup ol{margin:5px 0 15px;list-style:none outside none}#zzBackup li:before{counter-increment:section;content:counter(section) '.';width:30px;display:inline-block;text-align:right;margin-right:5px}.backupOption{font-size:18px;color:#00a8a1}#importNoti strong{color:#DA4FB8}#zzBackup dt label{display:block;margin-top:10px;color:#777}#zzBackup dt label:hover{color:#111}#zzBackup label input:checked ~ span{color:#0094CA}.buttonOne{display:none;margin-top:10px;padding:7px 20px;background:#f90e5e;color:#FFF;font-weight:700;border:3px solid #DDD}.buttonOne:hover{border-color:#444;cursor:pointer}.buttonOne:active{background:#444}#zzBackup :disabled,#zzBackup :disabled ~ span{color:#999;cursor:not-allowed}");
addscript(GM_getResourceText("jszip"));
addscript(GM_getResourceText("jsziputils"));
addscript(GM_getResourceText("filesaver"));
addscript(GM_getResourceText("zzFmBackup"));



 /**
 * zzFmBackup
 * ForumotionBackupTemplates
 * v2.0.1
 * Zzbaivong <http://devs.forumvi.com> *
 */

var goodIcon = "http://i.imgur.com/YNQGXWY.png",
    badIcon = "http://i.imgur.com/cf2Pe8g.png",
    disableIcon = "http://i.imgur.com/06GXmA1.png",
    errorIcon = "http://i.imgur.com/ffXpTVP.gif",
    infoIcon = "http://i.imgur.com/Tuv2aWf.png",
    loadIcon = "http://i.imgur.com/m3NXDa6.gif",
    successIcon = "http://i.imgur.com/R7Y7JtX.gif";

var allowNotification = true;
Notification.requestPermission(function (result) {
    if (result === "denied") {
        allowNotification = false;
        // console.log("Permission wasn't granted. Allow a retry.");
        return;
    } else if (result === "default") {
        allowNotification = false;
        // console.log("The permission request was dismissed.");
        return;
    }
    allowNotification = true;
});


/**
 * YÃªu c?u c?p phÃ©p b?t thÃ´ng bÃ¡o n?u chua du?c b?t
 */
if (Notification.permission !== "denied") {
    Notification.requestPermission();
}


/**
 * L?y th?i gian hi?n t?i
 * @return {Number} Th?i gian hi?n t?i, khÃ´ng tÃ­nh giÃ¢y
 */
function timestamp() {
    return Math.floor((new Date()).getTime() / 1000);
}


/**
 * H? tr? ngÃ´n ng? Anh vÃ  Vi?t
 * @type {Object}
 */
var lang = {
    vi: {
        ex: {
            title: "Xu?t Template",
            tooltip: "Trong b?ng nÃ y, b?n cÃ³ th? xu?t t?t c? [[template dÃ£ du?c thay d?i]] c?a b?n vÃ o m?t t?p tin nÃ©n (.zip) vÃ  t?i nÃ³ v? mÃ¡y.\nÃ? b?t d?u, b?n nh?n vÃ o nÃºt {{Ki?m tra}} d? l?y thÃ´ng tin phiÃªn b?n vÃ  danh sÃ¡ch template c?n xu?t. Sau dÃ³ nh?n {{XÃ¡c nh?n}} vÃ  ch? ti?n trÃ¬nh hoÃ n thÃ nh.",
            checkall: "Ch?n t?t c?",
            unpublish: "Template chua cÃ´ng khai",
            firsttip: "Ch?n cÃ¡c m?c ch?a template c?n luu tr? vÃ  nh?n {{Ki?m tra}}.",
            download: "T?p tin dang du?c t?i xu?ng. Nh?n vÃ o dÃ¢y n?u b?n d?i quÃ¡ lÃ¢u.",
            download2: "Template c?a b?n dÃ£ du?c t?i xong.",
            notemplate: "KhÃ´ng cÃ³ template c?n luu tr?.",
            sumtemplate: "T?ng s? template c?n luu tr? lÃ ",
            presssubmit: "Nh?n {{XÃ¡c nh?n}} d? b?t d?u!",
            pressrefresh: "Nh?n {{LÃ m l?i}} d? ch?n m?c khÃ¡c!",
            loading: "Ãang t?o t?p tin luu tr?..."
        },
        im: {
            title: "Nh?p Template",
            tooltip: "Trong b?ng nÃ y, b?n cÃ³ th? nh?p template t? t?p tin nÃ©n (.zip) dÃ£ luu tr? tru?c dÃ³. Luu Ã½ r?ng: di?n dÃ n ph?i du?c ch?y cÃ¹ng phiÃªn b?n v?i b?n luu tr?.\nÃ? b?t d?u, b?n nh?n [[Ch?n t?p]] (Browse...) vÃ  tÃ¬m d?n v? trÃ­ t?p tin luu tr?. Sau dÃ³ nh?n {{XÃ¡c nh?n}} vÃ  ch? ti?n trÃ¬nh hoÃ n thÃ nh.",
            choose: "Ch?n t?p tin luu tr?",
            notpublish: "KhÃ´ng cÃ´ng khai template",
            firsttip: "Ch?n t?p tin dÃ£ luu tr? vÃ  nh?n {{XÃ¡c nh?n}}.",
            notname: "L?i khÃ´ng tuong thÃ­ch! TÃªn t?p tin <<khÃ´ng h?p l?>>.",
            notversion: "L?i khÃ´ng tuong thÃ­ch! T?p tin nÃ y luu tr? Template cho phiÃªn b?n",
            source: "Ngu?n",
            version: "PhiÃªn b?n",
            time: "Luu lÃºc",
            count: "S? template",
            updateAll: "T?t c? template dÃ£ du?c c?p nh?t.",
            loading: "Ãang c?p nh?t template..."
        },
        option: "TÃ¹y ch?n",
        simpleclick: "Ch? d? 1-Click",
        wail: "Vui lÃ²ng ch? trong giÃ¢y lÃ¡t...",
        notsupport: "TrÃ¬nh duy?t c?a b?n khÃ´ng h? tr? ?ng d?ng nÃ y!",
        requestlimit: "L?i mÃ¡y ch? t? ch?i truy c?p! Ti?n trÃ¬nh s? b?t d?u l?i sau",
        reloadtemplate: "T?i l?i template ",
        errortemplate: "L?i template ",
        second: "giÃ¢y.",
        filtering: "Ãang ki?m tra...",
        checkone: "B?n ph?i ch?n Ã­t nh?t 1 m?c!",
        bt: {
            filter: "Ki?m tra",
            refresh: "LÃ m l?i",
            submit: "XÃ¡c nh?n",
            start: "B?T Ã?U"
        }
    },
    en: {
        ex: {
            title: "Exporta Template",
            tooltip: "In questa tabella puoi esportare un template [[dopo la modifica]] in un files forumato *.zip direttamente sul tuo computer.\per iniziare clicca su {{Check}} il bottone per ottenere le informazioni sulla versione e l'elenco dei template che si desidera esportare. Clicca su {{Ok}}, attendi qualche secondo e puoi cominciare.",
            checkall: "Scegli tutto",
            unpublish: "Template in attesa",
            firsttip: "E neccessario scegliere le categorie e clicca su {{Check}}.",
            download: "Se il download e' troppo lungo per scaricare il template clicca qui!",
            download2: "I template sono stati scaricati,con successo.",
            notemplate: "Non ci sono template modificati da salvare",
            sumtemplate: "E necessario inserire il numero dei template's",
            presssubmit: "Clicca su {{Ok}} per cominciare!",
            pressrefresh: "Clicca su {{Start over}} per modificare le opzioni!",
            loading: "Creazione si un files zip..."
        },
        im: {
            title: "Importa Template",
            tooltip: "In questa tabella, Ã¨ possibile importare il template il file * .zip. Attenzione: la versione deve corrispondere con la versione del template che si sta per importare.\per iniziare clicca su [[Apri file]] (Sfoglia...) seleziona il file del template sippato (*.zip). clicca su {{Ok}}, attendi il caricamento.",
            choose: "Aprire il file zippato",
            notpublish: "Non istallare il template...solo anteprima",
            firsttip: "Scegli il tuo file zippato e clicca su {{Ok}}.",
            notname: "Opps!Questo template  <<non e' valido>>.",
            notversion: "Opps!Questo template richiede  ",
            source: "Fonte",
            version: "Versione",
            time: "Ultimo aggiornamento",
            count: "Template(s)",
            updateAll: "Ripristino eseguito con successo!",
            loading: "Modello in aggiornamento..."
        },
        option: "Opzioni",
        simpleclick: "Controlla tutti",
        wail: "Attendere...",
        notsupport: "Il tuo browser non supporta questa applicazione!",
        requestlimit: "Accesso negato ! ",
        reloadtemplate: "Ricaricare template ",
        errortemplate: "template con bug ",
        second: "s.",
        filtering: "Filtraggio template...",
        checkone: "Scegliere almeno 1 template",
        bt: {
            filter: "Check",
            refresh: "Start over",
            submit: "Ok",
            start: "Start",
        }
    }
};

var icons = {
    load: loadIcon,
    info: infoIcon,
    error: errorIcon,
    success: successIcon,
    disable: disableIcon
};


var langCode = "en",
    trans;
if ($("#user_connected .txt_blue:last").text() === "ThoÃ¡t") {
    langCode = "vi";
}
trans = lang[langCode]; // Ch?n gÃ³i ngÃ´n ng?


if (allowNotification) {
    new Notification("Backup templates", {
        body: trans.bt.start,
        icon: goodIcon
    });
}

/**
 * Chuy?n cÃ¡c kÃ½ hi?u trong gÃ³i ngÃ´n ng? sang 2 d?ng html vÃ  text
 * @param  {String} txt N?i dung ghi chÃº
 * @return {Object}     html, text
 */
function showTip(txt) {
    return {
        html: txt.replace(/{{([^\}\}]+)}}/g, "<span style=\"color:green\">$1</span>").replace(/\[\[([^\]\]]+)\]\]/g, "<span style=\"color:#444\">$1</span>").replace(/<<([^>>]+)>>/g, "<strong>$1</strong>").replace(/\n/g, "<br />"),
        text: txt.replace(/{{([^\}\}]+)}}/g, "$1").replace(/\[\[([^\]\]]+)\]\]/g, "$1").replace(/<<([^>>]+)>>/g, "$1")
    };
}


/**
 * Ã?nh d?ng th?i gian
 * @param  {Number} time ThÃ´ng s? th?i gian
 * @return {String}      Th?i gian dÃ£ d?nh d?ng
 */
function timeFormat(time) {
    var a = (new Date(time)).toString().split(/\s/),
        dd = a[2],
        mm = {
            Jan: "01",
            Feb: "02",
            Mar: "03",
            Apr: "04",
            May: "05",
            Jun: "06",
            Jul: "07",
            Aug: "08",
            Sep: "09",
            Oct: "10",
            Nov: "11",
            Dec: "12"
        }[a[1]],
        yyyy = a[3],
        showTime = mm + "/" + dd + "/" + yyyy + " " + a[4];
    if (langCode === "vi") {
        showTime = dd + "-" + mm + "-" + yyyy + " " + a[4];
    }
    return showTime;
}


var tId = $("a", "#activetab").attr("href").match(/&tid=([^&?]+)/)[1]; // MÃ£ truy c?p ACP

var progressIsRun = true;
function progressIsRunning(e) {
    var message = "Programma in esecuzione.";
    e.returnValue = message;
    return message;
}

function alertUnload() {
    if (progressIsRun) {
        $(window).on("beforeunload", progressIsRunning);
    }
    progressIsRun = false;
}

function alertUnloadOff() {
    if (!progressIsRun) {
        $(window).off("beforeunload", progressIsRunning);
    }
    progressIsRun = true;
}

/**
 * Hi?n th? ghi chÃº kÃ¨m bi?u tu?ng
 * @param  {htmlString} mess N?i dung ghi chÃº
 * @param  {String} icon Lo?i hi?u tu?ng: load/info/error/success/disabled
 * @param  {Selector} imp  V? trÃ­ hi?n th? ghi chÃº
 */
function noti(mess, icon, imp) {
    var showIcon = "<img src=\"" + icons[icon] + "\" alt=\"icon\" style=\"height: 13px; width: 13px; vertical-align: middle; margin-top: -3px;\" > ";
    if (!icon) {
        showIcon = "";
    }
    var se = "#exportNoti";
    if (imp) {
        se = "#importNoti";
    }
    $(se).html(showIcon + showTip(mess).html);
    // console.log(showTip(mess).text);
}


/**
 * Cu?n d?n d?i tu?ng
 * @param  {Selector} Id Ã?i tu?ng c?n cu?n d?n
 */
function scrollGoto(Id) {
    $("body, html").animate({
        scrollTop: $("#" + Id).offset().top
    });
}


var arrTempExport = []; // Danh sÃ¡ch cÃ¡c Template du?c chon d? luu tr?
var zip = new JSZip(); // T?o d? li?u zip m?i
var prevZip = ""; // D? li?u t?p zip tru?c dÃ³
var forumVersion = ""; // PhiÃªn b?n Forumotion dang s? d?ng

/**
 * Thay th? bi?u tu?ng
 * @param  {Selector} se   Ã?i tu?ng cÃ³ bi?u tu?ng c?n thay
 * @param  {String} icon Lo?i bi?u tu?ng: load/info/error/success/disabled
 */
function replaceIcon(se, icon) {
    var img = $(se).next("img");
    if (img.length) {
        img.attr({
            "class": "icon_" + icon,
            src: icons[icon]
        });
    } else {
        $(se).hide().after("<img class=\"icon_" + icon + "\" src=\"" + icons[icon] + "\" alt=\"icon\" style=\"height: 13px; width: 13px;\" />");
    }
}


/**
 * X? lÃ½ khi b? t? ch?i truy c?p
 * @param  {Boolean}   exim     Khu v?c x?y ra l?i {true:Import, false:Export}
 * @param  {Number}   time     Th?i gian ch?
 * @param  {Selector}   se       V? trÃ­ x?y ra l?i
 * @param  {String}   temp     Template b? l?i
 * @param  {Selector}   Id       V? trÃ­ hi?n th? d?m ngu?c tuong ?ng v?i khu v?c
 * @param  {Function} callback X? lÃ½ khi h?t th?i gian ch?
 */
function requestLimit(exim, time, se, temp, Id, callback) {
    var place = "zzExport";
    if (exim) {
        place = "zzImport";
    }
    scrollGoto(place); // Cu?n d?n m?c b? l?i

    replaceIcon(se, "errore"); // Ã?i tr?ng thÃ¡i

    noti(trans.errortemplate + temp + "!", "errore", exim);
    noti(trans.requestlimit + " <span id=\"" + Id + "\" style=\"color:#FF0080\">" + time + "</span> " + trans.second, "errore", exim);
    if (allowNotification) {
        new Notification("Errore", {
            body: trans.requestlimit + " " + time + " " + trans.second,
            icon: badIcon
        });
    }
    // B?t d?u d?m ngu?c
    var count = time - 1,
        resum = setInterval(function () {
            var result = count--;
            $("#" + Id).html(result);

            if (result <= 0) {
                clearInterval(resum);
                replaceIcon(se, "load"); // Ã?i tr?ng thÃ¡i
                noti(trans.reloadtemplate + temp + "!", "info", exim);
                callback(); // X? lÃ½ khi h?t th?i gian ch?
            }
        }, 1000);
}

/**
 * Xu?t template ra vÃ  t?i v? mÃ¡y
 * @param  {Number} n V? trÃ­ template dang x? lÃ½ trong danh sÃ¡ch
 */
function exportTemp(n) {
    var item = arrTempExport[n];
    /**
     * item lÃ  m?t m?ng ch?a thÃ´ng tin c?a Template dang xÃ©t nhu sau
     * [0] Folder
     * [1] Temp Id
     * [2] Temp name
     */

    var bkLeg = arrTempExport.length; // Ki?m tra s? lu?ng Templates s? xu?t
    var m = n + 1; // V? trÃ­ Temp k? ti?p trong danh sÃ¡ch

    replaceIcon(".cusTemp[value='" + item[1] + "']", "load");

    // T?i Temp dang xÃ©t
    $.get("/admin/index.forum?part=themes&sub=templates&mode=edit_" + item[0] + "&t=" + item[1] + "&l=" + item[0] + "&extended_admin=1&tid=" + tId).done(function (data) { // X? lÃ½ khi t?i thÃ nh cÃ´ng

        zip.file(item[0] + "/" + item[1] + "." + item[2] + ".txt", $(data).find("#template").val()); // Luu thÃ´ng tin Temp dÃ£ t?i vÃ o t?p zip

        noti("(" + m + "/" + bkLeg + ") " + trans.ex.loading, "load");
        replaceIcon(".cusTemp[value='" + item[1] + "']", "successo");

        if (m < bkLeg) { // N?u v?n cÃ²n Temp trong danh sÃ¡ch

            // T?i Temp ti?p theo sau 1 giÃ¢y (th?i gian ch? nÃ y lÃ  d? trÃ¡nh l?i t? ch?i truy c?p)
            setTimeout(function () {
                exportTemp(m);
            }, 1000);
        } else { // Khi t?t c? Temp dÃ£ t?i xong

            var zipName = forumVersion + "." + timestamp() + "." + location.host + ".zip";
            var blob = zip.generate({
                type: "blob"
            });
            saveAs(blob, zipName); // T?o t?p zip

            if (prevZip) { // Ki?m tra xem d? li?u t?p zip cu cÃ²n luu trong trÃ¬nh duy?t khÃ´ng
                window.URL.revokeObjectURL(prevZip); // XÃ³a t?p zip cu n?u cÃ²n
            }
            prevZip = blob; // Luu t?p zip hi?n t?i thÃ nh d? li?u zip cu d? dÃ¹ng khi t?i xu?ng b? l?i

            $("#exportWait, #exportOne, #exportStart").prop("disabled", false);

            noti("<a href=\"" + window.URL.createObjectURL(blob) + "\" download=\"" + zipName + "\">" + trans.ex.download + "</a>", "successo");

            scrollGoto("zzExport");
            $("#refreshTemp").show();

            if (allowNotification) {
                new Notification("Complimenti", {
                    body: trans.ex.download2,
                    icon: goodIcon
                });
            }

            alertUnloadOff();
        }
    }).fail(function () { // X? lÃ½ khi t?i b? l?i

        // G?i phuong th?c x? lÃ½ khi b? t? ch?i truy c?p, ch? 60 giÃ¢y tru?c khi ti?p t?i
        requestLimit(false, 60, ".cusTemp[value='" + item[1] + "']", item[2], "exportResume", function () {
            exportTemp(n);
        });
    });
}


/**
 * T?i lÃªn thÃ nh cÃ´ng m?t Temp
 * @param  {Number} m      V? trÃ­ Temp t?i lÃªn k? ti?p
 * @param  {Number} bkLeg  T?ng s? lu?ng Temp t?i lÃªn
 * @param  {[type]} tempId Temp Id
 */
function importSuccess(m, bkLeg, tempId) {
    replaceIcon(".cusTemp2[value='" + tempId + "']", "successo");
    noti("(" + $(".hasTemp2 li .icon_success").length + "/" + $(".cusTemp2:checked").length + ") " + trans.im.loading, "load", true);
}


/**
 * Ti?n trÃ¬nh sau khi k?t thÃºc t?i lÃªn m?t Temp
 * @param  {Number} m      V? trÃ­ Temp t?i lÃªn k? ti?p
 * @param  {Number} bkLeg  T?ng s? lu?ng Temp t?i lÃªn
 * @param  {Boolean} nopick TÃ¹y ch?n xu?t b?n Temp
 */
function importEnd(m, bkLeg, nopick) {
    if (m < bkLeg) { // N?u cÃ²n Temp trong danh sÃ¡ch
        if (nopick) { // Tru?ng h?p Temp khÃ´ng du?c ch?n d? xu?t b?n
            importTemp(m); // Ti?p t?c ngay v?i Temp k? ti?p trong danh sÃ¡ch
        } else {

            // Ch? 2 giÃ¢y m?i ti?p t?c d? trÃ¡nh l?i t? ch?i truy c?p
            setTimeout(function () {
                importTemp(m);
            }, 2000);
        }
    } else { // Khi dÃ£ t?i lÃªn t?t c? Temp
        $("#importPublish, #importZip, #importOne, #importStart").prop("disabled", false);
        noti(trans.im.updateAll, "Complimenti", true);
        scrollGoto("zzImport");
        if (allowNotification) {
            new Notification("Complimenti", {
                body: trans.im.updateAll,
                icon: goodIcon
            });
        }

        alertUnloadOff();
    }
}


/**
 * Xu?t b?n m?t Temp sau khi t?i lÃªn
 * @param  {Selector} se       V? trÃ­ bi?u tu?ng
 * @param  {Number} m        V? trÃ­ Temp trong danh sÃ¡ch t?i lÃªn
 * @param  {Number} bkLeg    T?ng s? lu?ng Temp t?i lÃªn
 * @param  {String} tempId   Temp Id
 * @param  {String} tempName Temp Name
 * @param  {URL} link     LiÃªn k?t truy v?n d? xu?t b?n Temp sau khi t?i lÃªn
 */
function importPublish(se, m, bkLeg, tempId, tempName, link) {
    replaceIcon(se, "load");
    $.post(link).done(function () {
        importSuccess(m, bkLeg, tempId);
        importEnd(m, bkLeg);
    }).fail(function () {
        requestLimit(true, 120, se, tempName, "importResume", function () {
            importPublish(se, m, bkLeg, tempId, tempName, link);
        });
    });
}


var zipTemp = []; // Danh sÃ¡ch cÃ¡c Temp trong t?p zip t?i lÃªn

/**
 * T?i lÃªn m?t Temp
 * @param  {Number} n V? trÃ­ Temp trong danh sÃ¡ch t?i lÃªn
 */
function importTemp(n) {

    var temp = zipTemp[n];
    /**
     * ThÃ´ng s? c?a m?t Temp
     * [wail] Temp dÃ£ s?a nhung khÃ´ng du?c xu?t b?n
     * [l] Temp Mode
     * [t] Temp Id
     * [tpl_name] Temp Name
     * [template] N?i dung Temp
     */

    var bkLeg = zipTemp.length;
    var m = n + 1;
    var tempId = temp.t;
    var tempMode = temp.l;
    var tempName = temp.tpl_name;
    var se = ".cusTemp2[value=\"" + tempId + "\"]";

    if ($(se).is(":checked")) { // N?u temp du?c ngu?i dÃ¹ng ch?n

        // B?t d?u t?i lÃªn
        replaceIcon(se, "load");
        $.post("/admin/index.forum?part=themes&sub=templates&mode=edit_" + tempMode + "&extended_admin=1&tid=" + tId, {
            t: tempId,
            l: tempMode,
            tpl_name: tempName,
            template: temp.template,
            submit: "Save"
        }).done(function () {
            if (temp.wail && !$("#importPublish").is(":checked")) { // Xu?t b?n Temp

                // Ch? 2 giÃ¢y d? trÃ¡nh l?i t? ch?i truy c?p
                setTimeout(function () {
                    importPublish(se, m, bkLeg, tempId, tempName, "/admin/index.forum?part=themes&sub=templates&mode=edit_" + tempMode + "&t=" + tempId + "&l=" + tempMode + "&main_mode=edit&extended_admin=1&pub=1&tid=" + tId);
                }, 2000);
            } else { // N?u Temp khÃ´ng cho phÃ©p xu?t b?n thÃ¬ ti?p t?c v?i Temp k? ti?p
                importSuccess(m, bkLeg, tempId);
                importEnd(m, bkLeg);
            }
        }).fail(function () {

            // X? lÃ½ l?i t? ch?i truy c?p, ch? 120 giÃ¢y tru?c khi b?t d?u l?i
            requestLimit(true, 120, se, tempName, "importResume", function () {
                importTemp(n);
            });
        });
    } else { // N?u khÃ´ng du?c ch?n

        importEnd(m, bkLeg, true); // K?t thÃºc ti?n trÃ¬nh vÃ  ti?p t?c v?i Temp k? ti?p
    }
}

var arrTest = [];
/**
 * L?p danh sÃ¡ch template dÃ£ du?c thay d?i
 * @param  {Number} n V? trÃ­ nhÃ³m Temp trong danh sÃ¡ch
 */
function testTemp(n) {

    var cat = arrTest[n];
    var se = ".catTemp[value='" + cat + "']";
    var $this = $(se);
    var catWrap = $this.parent().parent();
    var m = n + 1;
    var bkLeg = arrTest.length;

    replaceIcon(se, "load");

    $.get("/admin/index.forum?mode=" + cat + "&part=themes&sub=templates&tid=" + tId).done(function (data) {

        // Ki?m tra Temp dÃ£ ch?nh s?a mÃ  chua luu
        var tempWait = "";
        if ($("#exportWait").is(":checked")) {
            tempWait = ", td.row1 span[style=\"color:red\"]";
        }

        // T?p h?p danh sÃ¡ch cÃ¡c Temp dÃ£ s?a (bao g?m Temp chua luu n?u du?c ch?n)
        var $customTemp = $(data).find("td.row1 span[style=\"color:#7CBA2C\"]" + tempWait).parent();

        var showResult = "";
        var status = "noTemp";

        if ($customTemp.length) { // CÃ³ Temp dÃ£ ch?nh s?a
            $customTemp.each(function () {

                // ÃÃ¡nh d?u x vÃ o tÃªn c?a Temp chua luu
                var markWail = "";
                if ($(this).find("span[style=\"color:red\"]").length) {
                    markWail = "x";
                }

                var customTempId = this.search.match(/&t=(\d+)&/)[1];
                showResult += "<li><label><input class=\"cusTemp\" type=\"checkbox\" value=\"" + customTempId + markWail + "\" checked /> " + $(this).html() + "</label></li>";
            });
            status = "hasTemp";

        } else { // KhÃ´ng cÃ³ tem ch?nh s?a
            $this.prop("checked", false);
            showResult = "<li><img src=\"" + icons.disable + "\" alt=\"icon\" style=\"height: 13px; width: 13px;\" /> <em>" + trans.ex.notemplate + "</em></li>";
        }

        catWrap.attr("class", status);
        $("#listTemp ." + cat).html(showResult);

        replaceIcon(se, "success");
        noti("(" + m + "/" + bkLeg + ") " + trans.filtering, "load");

        if (m < bkLeg) { // N?u cÃ²n nhÃ³m Temp trong danh sÃ¡ch

            setTimeout(function () {
                testTemp(m);
            }, 500); // Ch? 0.5 giÃ¢y vÃ  ki?m tra nhÃ³m k? ti?p

        } else { // Khi dÃ£ ki?m tra toÃ n b? nhÃ³m temp

            // Ã?m t?ng s? Temp vÃ  thÃ´ng bÃ¡o
            var sumTemp = $(".cusTemp").length;
            var mess = trans.ex.presssubmit;
            if (sumTemp === 0) {
                mess = trans.ex.pressrefresh;
                $("#exportTemp").hide();
            }
            noti(trans.ex.sumtemplate + ": <span style=\"color:#FF0080\">" + sumTemp + "</span>.\n" + mess, "info");

            if ($("#exportOne").prop("checked")) {
                $("#exportTemp").click();
            }
        }
    }).fail(function () {
        requestLimit(false, 60, se, cat, "testResume", function () {
            testTemp(n);
        });
    });
}

var listTempGroup = {
    main: "Generale",
    portal: "Portale",
    gallery: "Galleria",
    calendar: "Calendario",
    group: "Gruppi",
    post: "Post & Messaggi Privati",
    moderation: "Moderazione",
    profil: "Profilo",
    mobile: "Versione mobile"
}; // Danh sÃ¡ch cÃ¡c nhÃ³m Templates

/**
 * T?o danh sÃ¡ch cÃ¡c nhÃ³m Templates d? ngu?i dÃ¹ng ch?n
 */
function menuTemp() {
    var listTemp = $("#listTemp");
    listTemp.empty();
    $.each(listTempGroup, function (key, val) {
        listTemp.append("<div><label><input class=\"catTemp\" type=\"checkbox\" value=\"" + key + "\" /> <strong style=\"color: #0014FF\">" + val + "</strong></label><ol class=\"" + key + "\"></ol></div>");
    });
}

// C?p nh?t thÃ´ng tin phiÃªn b?n Forumotion
$.get("/admin/index.forum?part=themes&sub=styles&mode=version&extended_admin=1&tid=" + tId, function (data) {
    forumVersion = $(data).find("dd:first > input:checked", "[name=\"form_version\"]").val();
});

// ThÃªm Forumotion Backup Templates vÃ o B?ng qu?n tr? giao di?n
$("blockquote").after("<div id=\"zzBackup\"><fieldset id=\"zzExport\" class=\"style-theme-export\"><legend>" + trans.ex.title + "</legend><p id=\"exportNoti\" class=\"messagebox\"></p><dl class=\"clearfix\"><dt><label for=\"exportAll\"><input id=\"exportAll\" type=\"checkbox\" value=\"\" style=\"display: none;\"><img src=\"http://illiweb.com/fa/admin/icones/question2.png\" title=\"" + showTip(trans.ex.tooltip).text + "\" class=\"show_tooltips\" align=\"absmiddle\"><span> " + trans.ex.checkall + "</span></label><br /><br /><span class=\"backupOption\">" + trans.option + "</span><br /><label for=\"exportWait\"><input id=\"exportWait\" type=\"checkbox\" value=\"\"><span> " + trans.ex.unpublish + "</span></label><label for=\"exportOne\"><input id=\"exportOne\" class=\"oneMode\" type=\"checkbox\" value=\"\"><span> " + trans.simpleclick + "</span></label><button id=\"exportStart\" class=\"buttonOne\">" + trans.bt.start + "</button></dt><dd><div id=\"listTemp\"></div><div class=\"div_btns\"><input type=\"button\" id=\"testTemp\" name=\"testTemp\" value=\"" + trans.bt.filter + "\" class=\"icon_search\" /><input type=\"button\" id=\"refreshTemp\" name=\"refreshTemp\" value=\"" + trans.bt.refresh + "\" class=\"icon_refresh\" style=\"display: none;\" /><input type=\"button\" id=\"exportTemp\" name=\"exportTemp\" value=\"" + trans.bt.submit + "\" class=\"icon_ok\" style=\"display: none;\" /></div></dd></dl></fieldset><fieldset id=\"zzImport\" class=\"style-theme-export\"><legend>" + trans.im.title + "</legend><p id=\"importNoti\" class=\"messagebox\"></p><dl class=\"clearfix\"><dt><label for=\"importZip\"><img src=\"http://illiweb.com/fa/admin/icones/question2.png\" title=\"" + showTip(trans.im.tooltip).text + "\" class=\"show_tooltips\" align=\"absmiddle\"> " + trans.im.choose + "</label><br /><br /><span class=\"backupOption\">" + trans.option + "</span><br /><label for=\"importPublish\"><input id=\"importPublish\" type=\"checkbox\" value=\"\" /><span> " + trans.im.notpublish + "</span></label><label for=\"importOne\"><input id=\"importOne\" class=\"oneMode\" type=\"checkbox\" value=\"\"><span> " + trans.simpleclick + "</span></label><button id=\"importStart\" class=\"buttonOne\">" + trans.bt.start + "</button></dt><dd><input type=\"file\" id=\"importZip\" name=\"importZip\" accept=\"application/zip\" /><div id=\"readerTemp\" style=\"margin-top: 20px;\"></div><div class=\"div_btns\"><input type=\"button\" id=\"importTemp\" name=\"importTemp\" value=\"" + trans.bt.submit + "\" class=\"icon_ok\" /></div></dd></dl></fieldset></div>");

// T?o danh sÃ¡ch cÃ¡c nhÃ³m Temp trong khu v?c T?i xu?ng
menuTemp();

noti(trans.ex.firsttip, "info");


// EXPORT TEMPLATE

// Ch?n/b? ch?n ToÃ n b? Temp s? T?i xu?ng
$("#exportAll").change(function () {
    $(".catTemp").prop("checked", $(this).prop("checked"));
});

// Cu?n d?n khu v?c dang thao tÃ¡c (Ã? xem ghi chÃº ti?n trÃ¬nh)
$(":button", "#zzBackup").click(function () {
    scrollGoto($(this).closest("fieldset").attr("id"));
});

// L?y danh sÃ¡ch cÃ¡c Temp dÃ£ ch?nh s?a
$("#testTemp").click(function () {
    $("#exportWait, #exportOne, #exportStart").prop("disabled", true);
    arrTest = [];
    if ($(".catTemp:checked").length) { // N?u dÃ£ ch?n nhÃ³m Temp c?n ki?m tra
        alertUnload();

        $(this).hide();
        $("#refreshTemp, #exportTemp").show();

        replaceIcon(".catTemp:not(:checked)", "disable");
        noti(trans.wail, "load");

        $(".catTemp:checked").each(function () {
            arrTest.push($(this).val());
        });

        testTemp(0);
    } else { // N?u chua ch?n nhÃ³m Temp c?n ki?m tra

        noti(trans.checkone, "errore");

        alertUnloadOff();
    }
});

// LÃ m m?i cÃ¡c thÃ´ng s?
$("#refreshTemp").click(function () {
    arrTempExport = [];
    zip = new JSZip();
    $(this).add("#exportTemp").hide();
    $("#testTemp").show();
    menuTemp();
    $("#exportAll, #exportWait").prop("checked", false);
    $("#exportWait, #exportOne, #exportStart").prop("disabled", false);
    noti(trans.ex.firsttip, "info");

    alertUnloadOff();
});

// B?t d?u t?i xu?ng
$("#exportTemp").click(function () {
    if (!$(".cusTemp:checked").length) { // N?u khÃ´ng cÃ³ Temp ch?n t?i xu?ng

        $("#exportWait, #exportOne, #exportStart").prop("disabled", false);
        noti(trans.checkone, "errore");

        alertUnloadOff();
    } else {
        alertUnload();

        $(".cusTemp:checked").each(function () {
            var cus = [];
            var $this = $(this);
            cus[0] = $this.closest("ol").attr("class"); // Folder
            cus[1] = $this.val(); // Temp Id
            cus[2] = $this.next().text(); // Temp name
            arrTempExport.push(cus);
        });

        $(this).hide();
        $("#refreshTemp").hide();
        $(".cusTemp").prop("disabled", true);
        exportTemp(0);

        noti(trans.wail, "load");
        replaceIcon(".cusTemp:not(:checked)", "disable");
    }
});


// IMPORT TEMPLATE

var verName = {
    subsilver: "PhpBB2",
    prosilver: "PhpBB3",
    punbb: "PunBB",
    invision: "Invision"
}; // TÃªn phiÃªn b?n forumotion

noti(trans.im.firsttip, "info", true);

// B?t d?u T?i lÃªn
$("#importTemp").click(function () {
    if (!$(".cusTemp2:checked").length) {
        noti(trans.checkone, "errore", true);

        alertUnloadOff();
    } else {
        alertUnload();

        $(this).hide();
        noti(trans.wail, "load", true);
        replaceIcon(".cusTemp2:not(:checked), .catTemp2:not(:checked)", "disable");
        replaceIcon(".catTemp2:checked", "success");
        $(".cusTemp2, #importPublish, #importZip, #importOne, #importStart").prop("disabled", true);
        importTemp(0);
    }
});


var $result = $("#readerTemp"),
    vaild = true;

/**
 * Th?c hi?n khi phÃ¡t hi?n tÃªn t?p tin khÃ´ng h?p l?
 */
function notVaildName() {
    vaild = false;
    scrollGoto("zzImport");
    $("#importTemp").hide();

    noti(trans.im.notname, "errore", true);
    if (allowNotification) {
        new Notification("Errore", {
            body: showTip(trans.im.notname).text,
            icon: badIcon
        });
    }

    alertUnloadOff();
}

// T?i lÃªn t?p zip t? mÃ¡y tÃ­nh
$("#zzImport").on("change", "#importZip", function (evt) {
    alertUnload();

    $("#importTemp").show();
    scrollGoto("zzImport");
    $result.empty();
    var files = evt.target.files[0];
    var reader = new FileReader();

    reader.onload = (function (theFile) {

        return function (e) {

            // PhÃ¢n tÃ­ch tÃªn file d? l?y ra thÃ´ng s? c?n thi?t
            // invision.1432416686.devs.forumvi.com.zip
            var matchZip = /^(invision|punbb|prosilver|subsilver)\.(\d{10})\.(([\w\d\-]+\.)?([\w\d\-]+\.)\w{2,4})\.zip$/;
            var nameZip = theFile.name;
            if (!matchZip.test(nameZip)) { // N?u t?p khÃ´ng h?p l?
                notVaildName();

            } else {
                var backup = nameZip.match(matchZip);

                try {

                    // Ki?m tra phiÃªn b?n Forumotion
                    if (backup[1] !== forumVersion) {
                        noti(trans.im.notversion + " <<" + verName[backup[1]] + ">>.", "errore", true);
                        if (allowNotification) {
                            new Notification("Errore", {
                                body: trans.im.notversion + " " + verName[backup[1]],
                                icon: badIcon
                            });
                        }

                        alertUnloadOff();
                    } else {
                        var zipImport = new JSZip(e.target.result); // PhÃ¢n tÃ­ch t?p zip

                        noti("<<" + trans.im.source + ">>: <a href=\"http://" + backup[3] + "\" target=\"_blank\">" + backup[3] + "</a>\n<<" + trans.im.version + ">>: " + verName[backup[1]] + "\n<<" + trans.im.time + ">>: " + timeFormat(1E3 * parseInt(backup[2], 10)) + "\n<<" + trans.im.count + ">>: " + Object.keys(zipImport.files).length, false, true);

                        zipTemp = [];
                        $.each(zipImport.files, function (index, zipEntry) { // L?y d? li?u cÃ¡c t?p bÃªn trong

                            // PhÃ¢n tÃ­ch tÃªn file d? l?y ra thÃ´ng s? c?n thi?t
                            // main/110.index_body.txt
                            var nameFile = zipEntry.name;
                            if (!/^(main|portal|gallery|calendar|group|post|moderation|profil|mobile)\/\d{3,4}x?\.\w+\.txt$/.test(nameFile)) { // N?u t?p khÃ´ng h?p l?
                                $("#readerTemp").empty();
                                notVaildName();

                                return false;
                            }

                            // T?o nhÃ³m Temp
                            var arrName = nameFile.split(/\/|\./);
                            if (!$(".catTemp2[value=\"" + arrName[0] + "\"]").length) {
                                $result.append("<div class=\"hasTemp2\"><label><input class=\"catTemp2\" type=\"checkbox\" value=\"" + arrName[0] + "\" checked /> <strong style=\"color: #0014FF\">" + listTempGroup[arrName[0]] + "</strong></label><ol class=\"" + arrName[0] + "\"></ol></div>");
                            }

                            // ÃÃ¡nh d?u Temp khÃ´ng du?c xu?t b?n
                            var wailTemp = arrName[1].split("x");
                            var colorName = "#7CBA2C";
                            var wailStatus = true;
                            if (wailTemp.length === 2) {
                                colorName = "red";
                                wailStatus = false;
                            }

                            // ThÃªm Temp vÃ o nhÃ³m tuong ?ng
                            $("<li><label><input class=\"cusTemp2\" type=\"checkbox\" value=\"" + wailTemp[0] + "\" checked />&nbsp;<span style=\"color:" + colorName + "\">" + arrName[2] + "</span></label></li>").appendTo(".hasTemp2 ." + arrName[0]);

                            // T?o danh sÃ¡ch d? li?u cÃ¡c Temp
                            zipTemp.push({
                                wail: wailStatus,
                                l: arrName[0],
                                t: wailTemp[0],
                                tpl_name: arrName[2],
                                template: zipEntry.asText()
                            });
                        });

                        if ($("#importOne").prop("checked") && vaild) {
                            $("#importTemp").click();
                        }
                    }
                } catch (es) { // L?i trÃ¬nh duy?t khÃ´ng h? tr?
                    noti(trans.notsupport, "errore", true);
                    // console.log(es.message);
                }
            }
        };
    })(files);

    reader.readAsArrayBuffer(files);
    $("#importZip").replaceWith($("#importZip").clone());
});

// Ch?n/B? ch?n t?t c? Temp trong nhÃ³m
$("#zzBackup").on("change", ".catTemp, .catTemp2", function () {
    var $this = $(this);
    $(":checkbox", "." + $this.val()).prop("checked", $this.prop("checked"));
});

// ONE-CLICK MODE

$(".oneMode").on("change", function () {
    var $parent = $(this).closest("dl"),
        $start = $parent.find(".buttonOne"),
        $groupBtn = $parent.find(".div_btns");
    if ($(this).prop("checked")) {
        $start.show();
        $groupBtn.hide();
    } else {
        $start.hide();
        $groupBtn.show();
    }
});

$("#importStart").click(function () {
    alertUnload();

    $("#importZip").click();
});


$("#exportStart").click(function () {
    alertUnload();

    $("#refreshTemp").click();
    $("#exportAll, #exportWait, .catTemp").prop("checked", true);
    $("#testTemp").click();});
